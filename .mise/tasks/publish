#!/usr/bin/env bash
#MISE description="Publish to npm registry"
#MISE depends=["setup", "build"]
#USAGE flag "-t --tag <tag>" "Tag to publish with" default="latest"

set -e

# Pack with bun pm pack (leverages all bun build aspects)
echo "Packing with bun pm pack..."
TARBALL=$(bun pm pack --quiet | tr -d '\n')

if [ -z "$TARBALL" ]; then
  echo "Error: Failed to create tarball"
  exit 1
fi

echo "Packed tarball: $TARBALL"

# Publish with npm (better OIDC support in CI)
echo "Publishing to npm"

echo " > with tag: ${usage_tag}..."
echo " > from tarball: ${TARBALL}..."
echo " > npm version: $(npm --version)"

npm publish "$TARBALL" \
  --access public \
  --tag "${usage_tag}"

echo "Published successfully!"
