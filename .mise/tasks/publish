#!/usr/bin/env bash
#MISE description="Publish to npm registry"
#MISE depends=["setup", "build"]
#USAGE flag "-t --tag <tag>" "Tag to publish with" default="latest"

set -e

# Pack with bun (leverages all bun build aspects)
echo "Packing with bun..."
TARBALL=$(bun publish --dry-run --quiet 2>&1 | tail -1)

if [ -z "$TARBALL" ]; then
  echo "Error: Failed to determine tarball name"
  exit 1
fi

echo "Packed tarball: $TARBALL"

# Publish with npm (better OIDC support in CI)
echo "Publishing to npm with tag: ${usage_tag}..."
npm publish \
  --access public \
  --tag "${usage_tag}" \
  "$TARBALL"

echo "Published successfully!"
